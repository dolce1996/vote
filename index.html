<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>골프 참석 투표</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px 28px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 12px;
      text-align: center;
    }
    p.description {
      margin: 0 0 20px;
      font-size: 0.9rem;
      color: #6b7280;
      text-align: center;
    }
    .field { margin-bottom: 12px; }
    .field label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #4b5563;
    }
    .field input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
    }
    .option-row {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 0.9rem;
    }
    .option-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .option-row input[type="radio"] {
      accent-color: #4f46e5;
    }
    button[type="submit"] {
      width: 100%;
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      box-shadow: 0 8px 16px rgba(79, 70, 229, 0.25);
    }
    .status {
      font-size: 0.85rem;
      margin-top: 14px;
      text-align: center;
      color: #6b7280;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>골프 참석여부 투표</h1>

    <!-- JS가 이 위치에 화면을 렌더링 -->
    <div id="app">
      <div class="status">투표가 마감되었거나 아직 시작되지 않았습니다.</div>
    </div>
  </div>

<script>
  const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbzOxKKv14jjAajuFpusrA23Niu2ykhbjGG6fcAlfsBqr9-G_0o53Qq8jvnnyIGr19MyYw/exec";

  async function fetchStatus() {
    const res = await fetch(SCRIPT_URL + "?mode=status", { method: "GET", cache: "no-store" });
    return res.json(); // { ok:true, status:"start" }
  }

  async function sendVoteToServer(name, attend) {
    const params = new URLSearchParams({ name, attend });
    const res = await fetch(SCRIPT_URL, { method: "POST", body: params });
    return res.json();
  }

  function renderClosed() {
    document.getElementById("app").innerHTML =
      `<div class="status">투표가 <strong>마감</strong>되었거나 아직 시작되지 않았습니다.</div>`;
  }

  function renderForm() {
    document.getElementById("app").innerHTML = `
      <form id="vote-form">
        <div class="field">
          <label>이름</label>
          <input type="text" id="username" placeholder="예: 박세리" required />
        </div>

        <div class="field">
          <label>참석 여부</label>
          <div class="option-row">
            <label><input type="radio" name="attend" value="참석"> 참석</label>
            <label><input type="radio" name="attend" value="불참"> 불참</label>
          </div>
        </div>

        <button type="submit">투표하기</button>
        <div class="status" id="status-text">아직 투표 전입니다.</div>
      </form>
    `;

    document.getElementById("vote-form").addEventListener("submit", handleSubmit);
  }

  function getAttend() {
    const r = document.querySelector("input[name='attend']:checked");
    return r ? r.value : null;
  }

  async function handleSubmit(e) {
    e.preventDefault();

    const name = document.getElementById("username").value.trim();
    const attend = getAttend();
    const status = document.getElementById("status-text");

    if (!name) return alert("이름을 입력해 주세요.");
    if (!attend) return alert("참석 여부를 선택해 주세요.");

    status.textContent = "투표 전송 중…";

    const result = await sendVoteToServer(name, attend);

    if (!result.ok && result.error === "CLOSED") {
      renderClosed();
      return;
    }

    status.innerHTML =
      `<strong>${name}</strong> 님의 선택(<strong>${attend}</strong>)이 저장되었습니다.<br>마감 전까지 수정 가능합니다.`;
  }

  async function init() {
    try {
      const data = await fetchStatus();
      if (data.ok && data.status === "start") renderForm();
      else renderClosed();
    } catch (err) {
      renderClosed(); // 서버 오류도 마감 표시로 처리
    }
  }

  window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
